#!/bin/bash

# Copyright (C) 2016 NIWA Hideyuki

FULCONDRIVER=`fulcon driver-name`
PATH=/usr/lib/slot-os/lib:/usr/lib/fulcon/driver/$FULCONDRIVER:/usr/lib/fulcon/lib:$PATH

SLOTOSDIR=/var/lib/slot-os

usage()
{
	echo "usage: list [ SLOT_NUMBER ]"
}

lsdir() {
  ls -f --ind=none $1 | sed '/^\.\{1,2\}$/d'
}

list1()
{
	LIST=$1
	CNAME=`echo $LIST | awk '{print $1}'`
	STATUS=`echo $LIST | awk '{print $2}'`
	IMAGE=`echo $LIST | awk '{print $3}' | awk -F / '{print $2}'`
	IPADDR=`echo $LIST | awk '{for(i=4;i<=NF;i++)printf "%s ",$i}'`
	i=`echo $CNAME | sed -e 's/slot//g'`
	i=`expr $i + 0`

	if [ x"`slot-os autostart $i`" == x"on" ]; then
		AUTOSTART="A"
	else
		AUTOSTART="-"
	fi

	if [ -d $SLOTOSDIR/slot/$i ]; then
		printf "%2d : %8s %s %3s%% %3s %s %1s %s " \
			$i $STATUS $CNAME \
			`cat $SLOTOSDIR/slot/$i/cpu` \
			`cat $SLOTOSDIR/slot/$i/cpuset` \
			`cat $SLOTOSDIR/slot/$i/memory` \
			$AUTOSTART \
			$IMAGE
	fi

	echo $IPADDR
}


if [ $# -ne 1 ]; then
	usage
	exit -1
fi

if [ x"$1" != x"list" ]; then
	NUM=$1
	NUM=`echo $NUM | sed -e 's/slot//'` 
	NUM=`expr $NUM + 0`

	if [ -d $SLOTOSDIR/slot/$NUM ]; then
		list1 $NUM
		exit 0
	else
#		printf "error: slot%02d is not exist\n" $NUM
		exit -1
	fi
fi


if [ ! -d $SLOTOSDIR/slot -o ! -d $SLOTOSDIR/slot/0 ]; then
#	echo "error: there is no slot."
	exit -1
fi

SAVEIFS=IFS
IFS='
'
if [ x"$1" == x"list" ]; then
	for i in `fulcon list | egrep ^slot`
	do
		list1 $i
	done
else
	if [ -d $SLOTOSDIR/slot/$NUM ]; then
		CNAME=`cat $SLOTOSDIR/slot/$NUM/fulcon`
		list1 `fulcon list $CNAME`
	fi
fi
IFS=$SAVEIFS

exit 0
